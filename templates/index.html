<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Facial Attendance System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .loader {
            border-top-color: #4f46e5;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .webcam-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }
        
        #video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 2px dashed #4f46e5;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .recognition-animation {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid #10b981;
            animation: pulse 1.5s infinite;
            opacity: 0;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }
            
            70% {
                transform: scale(1);
                opacity: 0.2;
            }
            
            100% {
                transform: scale(0.95);
                opacity: 0.7;
            }
        }
        
        .tab-active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">DeepSeek Facial Attendance System</h1>
            <div class="flex items-center space-x-4">
                <button id="settings-btn" class="px-4 py-2 bg-indigo-800 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto py-8 px-4">
        <!-- Tabs Navigation -->
        <div class="flex justify-center mb-8">
            <div class="inline-flex rounded-md shadow-sm">
                <button id="tab-attendance" class="tab-active px-6 py-3 text-lg font-medium rounded-l-lg">
                    <i class="fas fa-user-check mr-2"></i>Take Attendance
                </button>
                <button id="tab-register" class="px-6 py-3 text-lg font-medium bg-white hover:bg-gray-200 transition">
                    <i class="fas fa-user-plus mr-2"></i>Register Student
                </button>
                <button id="tab-reports" class="px-6 py-3 text-lg font-medium bg-white hover:bg-gray-200 transition rounded-r-lg">
                    <i class="fas fa-chart-bar mr-2"></i>Attendance Reports
                </button>
            </div>
        </div>

        <!-- Take Attendance Tab -->
        <div id="attendance-section" class="bg-white p-6 rounded-lg shadow-md">
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Take Attendance</h2>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="w-full md:w-1/3">
                        <label class="block text-gray-700 mb-2">Select Class:</label>
                        <select id="attendance-class" class="w-full p-2 border border-gray-300 rounded">
                            <option value="">Loading classes...</option>
                        </select>
                    </div>
                    <div class="w-full md:w-1/3">
                        <label class="block text-gray-700 mb-2">Camera Source:</label>
                        <select id="camera-select" class="w-full p-2 border border-gray-300 rounded">
                            <option value="">Loading cameras...</option>
                        </select>
                    </div>
                    <div class="w-full md:w-1/3 flex items-end">
                        <button id="toggle-camera" class="w-full p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                            <i class="fas fa-video mr-2"></i>Start Camera
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/2">
                    <div class="webcam-container">
                        <video id="webcam" autoplay playsinline class="w-full rounded-lg shadow-md"></video>
                        <div id="video-overlay" class="hidden"></div>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <button id="take-attendance" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition disabled:opacity-50" disabled>
                            <i class="fas fa-camera mr-2"></i>Recognize Face
                        </button>
                    </div>
                </div>

                <div class="w-full md:w-1/2">
                    <div id="recognition-result" class="p-4 rounded-lg border-2 border-dashed border-gray-300 h-full min-h-[300px] flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-user-circle text-5xl mb-3"></i>
                            <p>Recognition results will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-4">Today's Attendance</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Name</th>
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Student ID</th>
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Class</th>
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Check-in Time</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table">
                            <tr>
                                <td colspan="4" class="py-4 text-center text-gray-500">No attendance records for today</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Register Student Tab -->
        <div id="register-section" class="bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-6">Register New Student</h2>
            
            <form id="register-form" class="mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 mb-2" for="student-name">Full Name:</label>
                        <input type="text" id="student-name" class="w-full p-2 border border-gray-300 rounded" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2" for="student-id">Student ID:</label>
                        <input type="text" id="student-id" class="w-full p-2 border border-gray-300 rounded" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2" for="student-class">Class:</label>
                        <select id="student-class" class="w-full p-2 border border-gray-300 rounded" required>
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Face Sample:</label>
                        <div class="flex items-center">
                            <button type="button" id="capture-sample" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                                <i class="fas fa-camera mr-2"></i>Capture
                            </button>
                            <span class="ml-2 text-sm text-gray-600">or</span>
                            <label class="ml-2 px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition cursor-pointer">
                                <i class="fas fa-upload mr-2"></i>Upload
                                <input type="file" id="upload-sample" class="hidden" accept="image/*">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-1/2">
                        <div class="webcam-container mb-4">
                            <video id="register-webcam" autoplay playsinline class="w-full rounded-lg shadow-md"></video>
                        </div>
                        <div class="flex justify-center">
                            <button type="button" id="toggle-register-camera" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                                <i class="fas fa-video mr-2"></i>Start Camera
                            </button>
                        </div>
                    </div>
                    <div class="w-full md:w-1/2">
                        <div id="sample-preview" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center">
                            <p class="text-gray-500">No face sample captured</p>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button type="submit" id="submit-registration" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition" disabled>
                                <i class="fas fa-save mr-2"></i>Register Student
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-4">Registered Students</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Photo</th>
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Name</th>
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Student ID</th>
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Class</th>
                                <th class="py-2 px-4 border-b border-gray-200 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table">
                            <tr>
                                <td colspan="5" class="py-4 text-center text-gray-500">No students registered</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-section" class="bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-6">Attendance Reports</h2>
            
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="w-full md:w-1/3">
                    <label class="block text-gray-700 mb-2">Class:</label>
                    <select id="report-class" class="w-full p-2 border border-gray-300 rounded">
                        <option value="">All Classes</option>
                    </select>
                </div>
                <div class="w-full md:w-1/3">
                    <label class="block text-gray-700 mb-2">Date Range:</label>
                    <div class="flex gap-2">
                        <input type="date" id="date-start" class="w-1/2 p-2 border border-gray-300 rounded">
                        <input type="date" id="date-end" class="w-1/2 p-2 border border-gray-300 rounded">
                    </div>
                </div>
                <div class="w-full md:w-1/3 flex items-end">
                    <button id="generate-report" class="w-full p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                        <i class="fas fa-search mr-2"></i>Generate Report
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto mt-6">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-4 border-b border-gray-200 text-left">Name</th>
                            <th class="py-2 px-4 border-b border-gray-200 text-left">Student ID</th>
                            <th class="py-2 px-4 border-b border-gray-200 text-left">Class</th>
                            <th class="py-2 px-4 border-b border-gray-200 text-left">Date</th>
                            <th class="py-2 px-4 border-b border-gray-200 text-left">Check-in Time</th>
                        </tr>
                    </thead>
                    <tbody id="report-table">
                        <tr>
                            <td colspan="5" class="py-4 text-center text-gray-500">Generate a report to see attendance data</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-right">
                <button id="export-csv" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                    <i class="fas fa-file-csv mr-2"></i>Export to CSV
                </button>
                <button id="print-report" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition ml-2">
                    <i class="fas fa-print mr-2"></i>Print Report
                </button>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">System Settings</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="settings-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Recognition Model:</label>
                    <select id="model-name" class="w-full p-2 border border-gray-300 rounded">
                        <option value="VGG-Face">VGG-Face (Default)</option>
                        <option value="Facenet">Facenet</option>
                        <option value="Facenet512">Facenet512</option>
                        <option value="OpenFace">OpenFace</option>
                        <option value="DeepFace">DeepFace</option>
                        <option value="ArcFace">ArcFace</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Recognition Threshold (Lower is stricter):</label>
                    <input type="range" id="threshold" min="0.1" max="0.9" step="0.05" value="0.4" class="w-full">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Strict (0.1)</span>
                        <span id="threshold-value">0.4</span>
                        <span>Lenient (0.9)</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Face Detector:</label>
                    <select id="detector-backend" class="w-full p-2 border border-gray-300 rounded">
                        <option value="opencv">OpenCV (Fast)</option>
                        <option value="mtcnn">MTCNN (Accurate)</option>
                        <option value="ssd">SSD</option>
                        <option value="retinaface">RetinaFace</option>
                    </select>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" id="reset-settings" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition mr-2">
                        Reset to Default
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                        Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-5 rounded-lg flex items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mr-4"></div>
            <p id="loading-message" class="text-xl">Processing...</p>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-y-[-100vh]">
        <div class="flex items-center">
            <div id="toast-icon-success" class="hidden">
                <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
            </div>
            <div id="toast-icon-error" class="hidden">
                <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
            </div>
            <div id="toast-icon-info" class="hidden">
                <i class="fas fa-info-circle text-blue-500 text-xl mr-3"></i>
            </div>
            <div id="toast-icon-warning" class="hidden">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mr-3"></i>
            </div>
            <p id="toast-message"></p>
        </div>
    </div>

    <script>
// Global variables
let stream = null;
let registerStream = null;
let videoElement = document.getElementById('webcam');
let registerVideoElement = document.getElementById('register-webcam');
let capturedSample = null;
let reportData = [];

// Initialize application
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tab navigation
    setupTabs();
    
    // Initialize camera functionality
    initCameraSelect();
    setupCameraButtons();
    
    // Initialize form submissions
    setupForms();
    
    // Load initial data
    loadClasses();
    loadStudents();
    loadTodayAttendance();
    
    // Initialize settings
    setupSettings();
    
    // Initialize date inputs for reports with default values
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(today.getMonth() - 1);
    
    document.getElementById('date-end').valueAsDate = today;
    document.getElementById('date-start').valueAsDate = lastMonth;
    
    // Setup report generation
    document.getElementById('generate-report').addEventListener('click', generateReport);
    document.getElementById('export-csv').addEventListener('click', exportReportToCsv);
    document.getElementById('print-report').addEventListener('click', printReport);
    
    // Setup face recognition button
    document.getElementById('take-attendance').addEventListener('click', takeAttendance);
    
    // Setup settings modal
    document.getElementById('settings-btn').addEventListener('click', function() {
        document.getElementById('settings-modal').classList.remove('hidden');
    });
    
    document.getElementById('close-settings').addEventListener('click', function() {
        document.getElementById('settings-modal').classList.add('hidden');
    });
    
    // Update threshold value display
    document.getElementById('threshold').addEventListener('input', function() {
        document.getElementById('threshold-value').textContent = this.value;
    });
});

// Tab Navigation
function setupTabs() {
    const tabButtons = ['tab-attendance', 'tab-register', 'tab-reports'];
    const sections = ['attendance-section', 'register-section', 'reports-section'];
    
    tabButtons.forEach((btnId, index) => {
        document.getElementById(btnId).addEventListener('click', () => {
            // Update button styles
            tabButtons.forEach(id => {
                document.getElementById(id).classList.remove('tab-active');
                document.getElementById(id).classList.add('bg-white', 'hover:bg-gray-200');
            });
            document.getElementById(btnId).classList.add('tab-active');
            document.getElementById(btnId).classList.remove('bg-white', 'hover:bg-gray-200');
            
            // Show/hide sections
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sections[index]).classList.remove('hidden');
            
            // Stop cameras when switching tabs
            if (btnId !== 'tab-attendance' && stream) {
                stopCamera();
                document.getElementById('toggle-camera').innerHTML = '<i class="fas fa-video mr-2"></i>Start Camera';
                document.getElementById('take-attendance').disabled = true;
            }
            
            if (btnId !== 'tab-register' && registerStream) {
                stopRegisterCamera();
                document.getElementById('toggle-register-camera').innerHTML = '<i class="fas fa-video mr-2"></i>Start Camera';
            }
        });
    });
}

// Camera Management
async function initCameraSelect() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        const cameraSelect = document.getElementById('camera-select');
        cameraSelect.innerHTML = '';
        
        if (videoDevices.length === 0) {
            cameraSelect.innerHTML = '<option value="">No cameras found</option>';
            return;
        }
        
        videoDevices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `Camera ${cameraSelect.options.length + 1}`;
            cameraSelect.appendChild(option);
        });
    } catch (error) {
        showToast('Error accessing cameras: ' + error.message, 'error');
    }
}

function setupCameraButtons() {
    // Main camera toggle
    document.getElementById('toggle-camera').addEventListener('click', async function() {
        if (stream) {
            stopCamera();
            this.innerHTML = '<i class="fas fa-video mr-2"></i>Start Camera';
            document.getElementById('take-attendance').disabled = true;
        } else {
            const cameraId = document.getElementById('camera-select').value;
            await startCamera(cameraId);
            if (stream) {
                this.innerHTML = '<i class="fas fa-video-slash mr-2"></i>Stop Camera';
                document.getElementById('take-attendance').disabled = false;
            }
        }
    });
    
    // Registration camera toggle
    document.getElementById('toggle-register-camera').addEventListener('click', async function() {
        if (registerStream) {
            stopRegisterCamera();
            this.innerHTML = '<i class="fas fa-video mr-2"></i>Start Camera';
        } else {
            await startRegisterCamera();
            if (registerStream) {
                this.innerHTML = '<i class="fas fa-video-slash mr-2"></i>Stop Camera';
            }
        }
    });
    
    // Capture sample button
    document.getElementById('capture-sample').addEventListener('click', captureFaceSample);
    
    // File upload
    document.getElementById('upload-sample').addEventListener('change', handleFileUpload);
}

async function startCamera(deviceId = null) {
    try {
        const constraints = {
            video: deviceId ? { deviceId: { exact: deviceId } } : true,
            audio: false
        };
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        document.getElementById('video-overlay').classList.remove('hidden');
        showToast('Camera started successfully', 'success');
        return true;
    } catch (error) {
        showToast('Error starting camera: ' + error.message, 'error');
        return false;
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        videoElement.srcObject = null;
        document.getElementById('video-overlay').classList.add('hidden');
    }
}

async function startRegisterCamera() {
    try {
        registerStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        registerVideoElement.srcObject = registerStream;
        return true;
    } catch (error) {
        showToast('Error starting camera: ' + error.message, 'error');
        return false;
    }
}

function stopRegisterCamera() {
    if (registerStream) {
        registerStream.getTracks().forEach(track => track.stop());
        registerStream = null;
        registerVideoElement.srcObject = null;
    }
}

function captureFaceSample() {
    if (!registerStream) {
        showToast('Please start the camera first', 'warning');
        return;
    }
    
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.width = registerVideoElement.videoWidth;
    canvas.height = registerVideoElement.videoHeight;
    context.drawImage(registerVideoElement, 0, 0, canvas.width, canvas.height);
    
    const imageData = canvas.toDataURL('image/jpeg');
    capturedSample = imageData;
    
    const previewArea = document.getElementById('sample-preview');
    previewArea.innerHTML = '';
    const img = document.createElement('img');
    img.src = imageData;
    img.className = 'rounded-lg h-full mx-auto';
    previewArea.appendChild(img);
    
    document.getElementById('submit-registration').disabled = false;
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.match('image.*')) {
        showToast('Please select an image file', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        capturedSample = e.target.result;
        
        const previewArea = document.getElementById('sample-preview');
        previewArea.innerHTML = '';
        const img = document.createElement('img');
        img.src = capturedSample;
        img.className = 'rounded-lg h-full mx-auto';
        previewArea.appendChild(img);
        
        document.getElementById('submit-registration').disabled = false;
    };
    reader.readAsDataURL(file);
}

// API Calls
async function loadClasses() {
    showLoading('Loading classes...');
    try {
        const response = await fetch('/api/classes');
        if (!response.ok) throw new Error('Failed to load classes');
        
        const data = await response.json();
        
        // Populate class selects
        const classSelects = [
            document.getElementById('attendance-class'),
            document.getElementById('student-class'),
            document.getElementById('report-class')
        ];
        
        classSelects.forEach(select => {
            select.innerHTML = '<option value="">All Classes</option>';
            
            data.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.name;
                option.textContent = cls.name;
                select.appendChild(option);
            });
        });
        
        hideLoading();
    } catch (error) {
        hideLoading();
        showToast('Error: ' + error.message, 'error');
    }
}

async function loadTodayAttendance() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const classFilter = document.getElementById('attendance-class').value;
        
        let url = `/api/attendance?date=${today}`;
        if (classFilter) {
            url += `&class=${encodeURIComponent(classFilter)}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load attendance');
        
        const data = await response.json();
        const tableBody = document.getElementById('attendance-table');
        
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">No attendance records for today</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        data.forEach(record => {
            const row = document.createElement('tr');
            
            const nameCell = document.createElement('td');
            nameCell.className = 'py-2 px-4 border-b border-gray-200';
            nameCell.textContent = record.student_name;
            
            const idCell = document.createElement('td');
            idCell.className = 'py-2 px-4 border-b border-gray-200';
            idCell.textContent = record.student_id;
            
            const classCell = document.createElement('td');
            classCell.className = 'py-2 px-4 border-b border-gray-200';
            classCell.textContent = record.class;
            
            const timeCell = document.createElement('td');
            timeCell.className = 'py-2 px-4 border-b border-gray-200';
            timeCell.textContent = record.check_in_time;
            
            row.appendChild(nameCell);
            row.appendChild(idCell);
            row.appendChild(classCell);
            row.appendChild(timeCell);
            
            tableBody.appendChild(row);
        });
    } catch (error) {
        showToast('Error loading attendance: ' + error.message, 'error');
    }
}

async function loadStudents() {
    showLoading('Loading students...');
    try {
        const response = await fetch('/api/students');
        if (!response.ok) throw new Error('Failed to load students');
        
        const data = await response.json();
        const tableBody = document.getElementById('students-table');
        
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No students registered</td></tr>';
            hideLoading();
            return;
        }
        
        tableBody.innerHTML = '';
        data.forEach(student => {
            const row = document.createElement('tr');
            
            // Create photo cell
            const photoCell = document.createElement('td');
            photoCell.className = 'py-2 px-4 border-b border-gray-200';
            const img = document.createElement('img');
            if (student.face_samples && student.face_samples.length > 0) {
                img.src = `/static/${student.face_samples[0]}`;
            } else {
                img.src = 'https://via.placeholder.com/50';
            }
            img.className = 'w-12 h-12 rounded-full object-cover';
            photoCell.appendChild(img);
            
            // Create other cells
            const nameCell = document.createElement('td');
            nameCell.className = 'py-2 px-4 border-b border-gray-200';
            nameCell.textContent = student.name;
            
            const idCell = document.createElement('td');
            idCell.className = 'py-2 px-4 border-b border-gray-200';
            idCell.textContent = student.student_id;
            
            const classCell = document.createElement('td');
            classCell.className = 'py-2 px-4 border-b border-gray-200';
            classCell.textContent = student.class;
            
            // Create actions cell
            const actionsCell = document.createElement('td');
            actionsCell.className = 'py-2 px-4 border-b border-gray-200';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'text-blue-500 hover:text-blue-700 mr-3';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.onclick = () => editStudent(student.id);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-red-500 hover:text-red-700';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => deleteStudent(student.id);
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
            
            // Append all cells to row
            row.appendChild(photoCell);
            row.appendChild(nameCell);
            row.appendChild(idCell);
            row.appendChild(classCell);
            row.appendChild(actionsCell);
            
            // Append row to table
            tableBody.appendChild(row);
        });
        
        hideLoading();
    } catch (error) {
        hideLoading();
        showToast('Error loading students: ' + error.message, 'error');
    }
}

// Form Handling
function setupForms() {
    // Student registration form
    document.getElementById('register-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!capturedSample) {
            showToast('Please capture or upload a face sample', 'warning');
            return;
        }
        
        const studentData = {
            name: document.getElementById('student-name').value,
            student_id: document.getElementById('student-id').value,
            class: document.getElementById('student-class').value,
            face_sample: capturedSample
        };
        
        showLoading('Registering student...');
        
        try {
            const response = await fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to register student');
            }
            
            const result = await response.json();
            
            // Reset form
            document.getElementById('register-form').reset();
            document.getElementById('sample-preview').innerHTML = '<p class="text-gray-500">No face sample captured</p>';
            capturedSample = null;
            document.getElementById('submit-registration').disabled = true;
            
            // Reload students list
            loadStudents();
            
            hideLoading();
            showToast('Student registered successfully', 'success');
        } catch (error) {
            hideLoading();
            showToast(error.message, 'error');
        }
    });
    
    // Settings form
    document.getElementById('settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const settingsData = {
            model_name: document.getElementById('model-name').value,
            threshold: document.getElementById('threshold').value,
            detector_backend: document.getElementById('detector-backend').value
        };
        
        showLoading('Updating settings...');
        
        try {
            const response = await fetch('/api/retrain', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settingsData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update settings');
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            hideLoading();
            showToast('Settings updated successfully', 'success');
        } catch (error) {
            hideLoading();
            showToast(error.message, 'error');
        }
    });
    
    // Reset settings
    document.getElementById('reset-settings').addEventListener('click', function() {
        document.getElementById('model-name').value = 'VGG-Face';
        document.getElementById('threshold').value = '0.4';
        document.getElementById('threshold-value').textContent = '0.4';
        document.getElementById('detector-backend').value = 'opencv';
    });
    
    // Class filter for attendance
    document.getElementById('attendance-class').addEventListener('change', loadTodayAttendance);
}

// Settings management
function setupSettings() {
    // Settings modal controls are handled in the DOMContentLoaded event listener
}

// Face Recognition
async function takeAttendance() {
    if (!stream) {
        showToast('Please start the camera first', 'warning');
        return;
    }
    
    showLoading('Processing face...');
    
    // Capture frame from video
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    
    const imageData = canvas.toDataURL('image/jpeg');
    
    try {
        // Show recognition animation
        const overlay = document.getElementById('video-overlay');
        const animation = document.createElement('div');
        animation.className = 'recognition-animation';
        overlay.appendChild(animation);
        animation.style.opacity = '1';
        
        // Get selected class
        const classId = document.getElementById('attendance-class').value;
        
        // Send to server for recognition
        const response = await fetch('/api/recognize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: imageData,
                class: classId
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Face recognition failed');
        }
        
        const result = await response.json();
        
        // Remove animation
        setTimeout(() => {
            animation.remove();
        }, 1000);
        
        // Display result
        const resultContainer = document.getElementById('recognition-result');
        
        if (result.recognized) {
            resultContainer.innerHTML = `
                <div class="text-center">
                    <div class="flex justify-center mb-4">
                        <img src="/static/${result.student.image}" class="w-24 h-24 rounded-full object-cover border-4 border-green-500">
                    </div>
                    <h3 class="text-xl font-bold text-green-600 mb-2">${result.student.name}</h3>
                    <div class="text-gray-700 mb-4">
                        <p><strong>Student ID:</strong> ${result.student.student_id}</p>
                        <p><strong>Class:</strong> ${result.student.class}</p>
                        <p><strong>Confidence:</strong> ${result.confidence.toFixed(2)}%</p>
                    </div>
                    <div class="bg-${result.attendance_recorded ? 'green' : 'blue'}-100 p-3 rounded-lg">
                        <p class="text-${result.attendance_recorded ? 'green' : 'blue'}-700">
                            ${result.attendance_recorded ? 'Attendance recorded successfully!' : 'Already marked present today'}
                        </p>
                        <p class="text-gray-600 text-sm">${result.date} ${result.time}</p>
                    </div>
                </div>
            `;
            
            // Reload today's attendance
            loadTodayAttendance();
            
            // Success sound
            const audio = new Audio('/static/sound/success.mp3');
            audio.play().catch(e => console.log('Audio play failed: ', e));
        } else {
            resultContainer.innerHTML = `
                <div class="text-center">
                    <div class="w-24 h-24 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-slash text-red-500 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-red-600 mb-2">No Match Found</h3>
                    <p class="text-gray-700">This face doesn't match any registered student.</p>
                </div>
            `;
            
            // Error sound
            const audio = new Audio('/static/sound/error.mp3');
            audio.play().catch(e => console.log('Audio play failed: ', e));
        }
        
        hideLoading();
    } catch (error) {
        hideLoading();
        document.getElementById('video-overlay').innerHTML = '';
        showToast(error.message, 'error');
    }
}

// Student Management
async function editStudent(studentId) {
    showToast('Edit functionality not implemented in this demo', 'info');
}

async function deleteStudent(studentId) {
    if (!confirm('Are you sure you want to delete this student?')) {
        return;
    }
    
    showLoading('Deleting student...');
    
    try {
        const response = await fetch(`/api/students/${studentId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete student');
        }
        
        // Reload students list
        loadStudents();
        
        hideLoading();
        showToast('Student deleted successfully', 'success');
    } catch (error) {
        hideLoading();
        showToast(error.message, 'error');
    }
}

// Report Functions
async function generateReport() {
    const classFilter = document.getElementById('report-class').value;
    const startDate = document.getElementById('date-start').value;
    const endDate = document.getElementById('date-end').value;
    
    if (!startDate || !endDate) {
        showToast('Please select a date range', 'warning');
        return;
    }
    
    showLoading('Generating report...');
    
    try {
        let url = `/api/attendance?start_date=${startDate}&end_date=${endDate}`;
        if (classFilter) {
            url += `&class=${encodeURIComponent(classFilter)}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to generate report');
        
        reportData = await response.json();
        const tableBody = document.getElementById('report-table');
        
        if (reportData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No attendance records found for the selected period</td></tr>';
            hideLoading();
            return;
        }
        
        tableBody.innerHTML = '';
        reportData.forEach(record => {
            const row = document.createElement('tr');
            
            const nameCell = document.createElement('td');
            nameCell.className = 'py-2 px-4 border-b border-gray-200';
            nameCell.textContent = record.student_name;
            
            const idCell = document.createElement('td');
            idCell.className = 'py-2 px-4 border-b border-gray-200';
            idCell.textContent = record.student_id;
            
            const classCell = document.createElement('td');
            classCell.className = 'py-2 px-4 border-b border-gray-200';
            classCell.textContent = record.class;
            
            const dateCell = document.createElement('td');
            dateCell.className = 'py-2 px-4 border-b border-gray-200';
            dateCell.textContent = record.date;
            
            const timeCell = document.createElement('td');
            timeCell.className = 'py-2 px-4 border-b border-gray-200';
            timeCell.textContent = record.check_in_time;
            
            row.appendChild(nameCell);
            row.appendChild(idCell);
            row.appendChild(classCell);
            row.appendChild(dateCell);
            row.appendChild(timeCell);
            
            tableBody.appendChild(row);
        });
        
        hideLoading();
        showToast('Report generated successfully', 'success');
    } catch (error) {
        hideLoading();
        showToast('Error generating report: ' + error.message, 'error');
    }
}

function exportReportToCsv() {
    if (reportData.length === 0) {
        showToast('No report data to export', 'warning');
        return;
    }
    
    // Create CSV content
    const headers = ['Name', 'Student ID', 'Class', 'Date', 'Check-in Time'];
    const csvContent = [
        headers.join(','),
        ...reportData.map(record => [
            record.student_name,
            record.student_id,
            record.class,
            record.date,
            record.check_in_time
        ].join(','))
    ].join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `attendance_report_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Report exported successfully', 'success');
}

function printReport() {
    if (reportData.length === 0) {
        showToast('No report data to print', 'warning');
        return;
    }
    
    // Create printable content
    const classFilter = document.getElementById('report-class').value || 'All Classes';
    const startDate = document.getElementById('date-start').value;
    const endDate = document.getElementById('date-end').value;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Attendance Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { text-align: center; color: #4f46e5; }
                .report-meta { margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #777; }
            </style>
        </head>
        <body>
            <h1>Attendance Report</h1>
            <div class="report-meta">
                <p><strong>Class:</strong> ${classFilter}</p>
                <p><strong>Period:</strong> ${startDate} to ${endDate}</p>
                <p><strong>Generated on:</strong> ${new Date().toLocaleString()}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Student ID</th>
                        <th>Class</th>
                        <th>Date</th>
                        <th>Check-in Time</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.map(record => `
                        <tr>
                            <td>${record.student_name}</td>
                            <td>${record.student_id}</td>
                            <td>${record.class}</td>
                            <td>${record.date}</td>
                            <td>${record.check_in_time}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="footer">
                <p>DeepSeek Facial Attendance System - Generated on ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
    }, 500);
}

// UI Helpers
function showLoading(message = 'Processing...') {
    document.getElementById('loading-message').textContent = message;
    document.getElementById('loading-overlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.add('hidden');
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${getToastIcon(type)} mr-2"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close">&times;</button>
    `;
    
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toast-container';
        document.body.appendChild(container);
    }
    
    document.getElementById('toast-container').appendChild(toast);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        toast.classList.add('toast-hide');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 5000);
    
    // Add close button functionality
    toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.classList.add('toast-hide');
        setTimeout(() => {
            toast.remove();
        }, 300);
    });
}

function getToastIcon(type) {
    switch (type) {
        case 'success':
            return 'fa-check-circle';
        case 'error':
            return 'fa-exclamation-circle';
        case 'warning':
            return 'fa-exclamation-triangle';
        default:
            return 'fa-info-circle';
    }
}

// Function to handle API errors consistently
function handleApiError(error) {
    console.error('API Error:', error);
    if (error.response && error.response.data && error.response.data.error) {
        showToast(error.response.data.error, 'error');
    } else {
        showToast('An unexpected error occurred. Please try again.', 'error');
    }
    hideLoading();
}

// Window resize handling for responsive layout
window.addEventListener('resize', function() {
    // Adjust video elements size if needed for responsiveness
    const videoContainers = document.querySelectorAll('.video-container');
    videoContainers.forEach(container => {
        const width = container.offsetWidth;
        const height = width * 0.75; // Maintain 4:3 aspect ratio
        container.style.height = `${height}px`;
    });
});

// Initialize the application when the window loads
window.addEventListener('load', function() {
    // Initialize any responsive elements
    const videoContainers = document.querySelectorAll('.video-container');
    videoContainers.forEach(container => {
        const width = container.offsetWidth;
        const height = width * 0.75; // Maintain 4:3 aspect ratio
        container.style.height = `${height}px`;
    });
    
    // Check browser compatibility
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('Your browser does not support camera access. Please use a modern browser like Chrome or Firefox.', 'error');
    }
});

// Add event listeners to filter inputs for real-time filtering
document.getElementById('search-students').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const studentRows = document.querySelectorAll('#students-table tr:not(:first-child)');
    
    studentRows.forEach(row => {
        const name = row.children[1].textContent.toLowerCase();
        const id = row.children[2].textContent.toLowerCase();
        const className = row.children[3].textContent.toLowerCase();
        
        if (name.includes(searchTerm) || id.includes(searchTerm) || className.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Add more robust error handling for camera access
async function handleCameraError(error) {
    console.error('Camera error:', error);
    
    if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
        showToast('No camera found. Please connect a camera and try again.', 'error');
    } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        showToast('Camera access denied. Please allow camera access and try again.', 'error');
    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
        showToast('Camera is in use by another application. Please close other applications and try again.', 'error');
    } else {
        showToast('Error accessing camera: ' + error.message, 'error');
    }
};